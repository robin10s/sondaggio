<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>Sondaggio Cibo e Musica</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      max-width: 800px;
      margin: auto;
      background: #f9f9f9;
      color: #333;
    }
    h1, h2 {
      text-align: center;
      color: #0056b3;
    }
    img {
      width: 100%;
      max-width: 400px;
      display: block;
      margin: 10px auto;
      border-radius: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .question-block, .consent-block {
      display: none;
      margin-bottom: 40px;
      background: #fff;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 0 15px rgba(0,0,0,0.1);
    }
    .visible {
      display: block;
    }
    .audio-inline {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      border: 1px solid #eee;
      padding: 10px;
      border-radius: 5px;
      background: #fafafa;
    }
    audio {
      flex: 1;
      margin-right: 15px;
    }
    .btn {
      margin-top: 25px;
      padding: 12px 25px;
      font-size: 18px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }
    .btn:hover {
      background-color: #0056b3;
    }
    form p {
      margin-top: 20px;
      margin-bottom: 8px;
      font-weight: bold;
    }
    input[type="number"], select {
      width: calc(100% - 20px);
      padding: 10px;
      margin-bottom: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    input[type="checkbox"] {
      margin-right: 8px;
      transform: scale(1.2); /* Rende la checkbox leggermente più grande */
    }
    label {
      font-weight: normal;
      margin-left: 5px;
    }
  </style>
</head>
<body>
  <h1>Sondaggio: Cibo e Musica</h1>

  <div id="quiz-container">
    </div>

  <script>
    const endpoint = "https://api.sheetbest.com/sheets/3eae5dbf-3ae8-41f2-bd48-e7fc1dea8729";
    const responses = []; // Array per memorizzare le risposte del quiz

    let currentQuestionIndex = 0; // Tiene traccia della domanda corrente visualizzata

    // Funzione per caricare e visualizzare le domande
    async function loadQuestions() {
      // Nascondi il blocco del consenso e mostra il container del quiz
      document.getElementById("consent-block").classList.remove("visible");
      document.getElementById("quiz-container").classList.add("visible"); // Rendi visibile il container, la prima domanda sarà 'visible' al suo interno

      try {
        const res = await fetch("/static/domande.json"); // Carica il file JSON
        if (!res.ok) {
          throw new Error(`Errore di rete: ${res.status} ${res.statusText}`);
        }
        const fullList = await res.json(); // fullList è l'array di tutti i blocchi domanda

        // Randomizza l'intera lista di domande e prendine 10.
        // Ogni elemento in 'fullList' è già un "blocchetto" completo (immagine + 4 audio).
        const randomQuestions = fullList.sort(() => Math.random() - 0.5).slice(0, 10);

        const container = document.getElementById("quiz-container");
        container.innerHTML = ''; // Pulisci il container prima di aggiungere nuove domande

        // Per ogni domanda (blocchetto) selezionata casualmente
        randomQuestions.forEach((questionData, index) => {
          const block = document.createElement("div");
          block.className = "question-block" + (index === 0 ? " visible" : ""); // Rendi visibile solo il primo blocco

          const img = document.createElement("img");
          // Usa direttamente il percorso dell'immagine dal blocchetto domanda corrente
          img.src = `/static/${questionData.immagine}`;
          block.appendChild(img);

          const form = document.createElement("form");

          // Itera sui 4 oggetti audio specifici di QUESTA domanda (blocchetto)
          questionData.audio.forEach((audioObj, i) => {
            const audioDiv = document.createElement("div");
            audioDiv.className = "audio-inline";

            const audio = document.createElement("audio");
            audio.controls = true;
            // Usa il percorso audio già corretto (con /static/) dal JSON
            audio.src = audioObj.src;

            const label = document.createElement("label");
            label.innerHTML = `<input type="checkbox" name="audio" value="${i + 1}"> Audio ${i + 1}`; // value 1, 2, 3, 4

            audioDiv.appendChild(audio);
            audioDiv.appendChild(label);
            form.appendChild(audioDiv);
          });

          // Elementi del form per l'emozione
          const emotionLabel = document.createElement("p");
          emotionLabel.textContent = "Che emozione ti ha suscitato la combinazione immagine/audio?";
          const select = document.createElement("select");
          select.name = "emozione";
          select.required = true;
          ["", "Gioia", "Tristezza", "Rabbia", "Paura", "Sorpresa", "Disgusto", "Serenità", "Frustrazione"].forEach(op => {
            const option = document.createElement("option");
            option.value = op;
            option.textContent = op === "" ? "Seleziona" : op;
            select.appendChild(option);
          });

          // Pulsante di navigazione (Avanti/Completa)
          const button = document.createElement("button");
          button.type = "submit";
          button.className = "btn";
          button.textContent = index < randomQuestions.length - 1 ? "Avanti" : "Completa"; // 'Completa' sull'ultima domanda del quiz

          form.appendChild(emotionLabel);
          form.appendChild(select);
          form.appendChild(button);

          // Gestione dell'invio del form per ogni domanda
          form.addEventListener("submit", async e => {
            e.preventDefault();
            const formData = new FormData(form);
            const selectedAudioIndices = formData.getAll("audio").map(Number); // Ottiene gli indici selezionati (1-based)

            if (selectedAudioIndices.length === 0) {
              alert("Seleziona almeno un audio per continuare.");
              return;
            }

            // Mappa gli indici selezionati ai dettagli dei brani
            const braniDettagli = selectedAudioIndices.map(i => {
                const audioIndex = i - 1; // Converti in indice 0-based
                if (questionData.audio[audioIndex]) {
                    // Restituisci l'intero oggetto audio per salvare più dettagli
                    return {
                        src: questionData.audio[audioIndex].src,
                        origine: questionData.audio[audioIndex].origine
                    };
                }
                return null;
            }).filter(Boolean); // Filtra eventuali null (dovuti a errori, ma utile per robustezza)

            const risposta = {
              immagine_id: questionData.immagine.match(/\d+/)[0], // Estrae solo il numero dall'immagine (es. '0001')
              audio_selezionati_indici: selectedAudioIndices.join(", "), // Es. "1, 3"
              brani_selezionati_dettagli: JSON.stringify(braniDettagli), // Salva i dettagli completi dei brani come stringa JSON
              emozione: formData.get("emozione")
            };

            responses.push(risposta); // Aggiunge la risposta all'array globale

            // Nasconde la domanda corrente
            block.classList.remove("visible");

            // Mostra la prossima domanda o le domande finali
            if (index < randomQuestions.length - 1 && container.children[index + 1]) {
              container.children[index + 1].classList.add("visible");
              currentQuestionIndex++; // Aggiorna l'indice della domanda corrente
            } else {
              mostraDomandeFinali(container); // Tutte le domande del quiz sono terminate
            }
          });

          block.appendChild(form);
          container.appendChild(block);
        });

      } catch (error) {
        console.error("Errore nel caricamento delle domande:", error);
        container.innerHTML = "<p>Si è verificato un errore nel caricamento del sondaggio. Riprova più tardi.</p>";
      }
    }

    // Funzione per mostrare le domande finali (demografiche)
    function mostraDomandeFinali(container) {
      container.innerHTML = ''; // Pulisci il container delle domande del quiz

      const finale = document.createElement("div");
      finale.className = "question-block visible"; // Rendi visibile il blocco finale
      finale.innerHTML = `
        <h2>Dati finali</h2>
        <form id="final-form">
          <p>Età:</p>
          <input type="number" name="eta" min="18" required><br>

          <p>Genere:</p>
          <select name="genere" required>
            <option value="">Seleziona</option>
            <option>Maschio</option>
            <option>Femmina</option>
            <option>Altro</option>
            <option>Preferisco non specificare</option>
          </select><br>

          <p>Esperienza con la musica:</p>
          <select name="musica" required>
            <option value="">Seleziona</option>
            <option>Lavoro nel settore</option>
            <option>Appassionato/a</option>
            <option>Non particolarmente interessato</option>
          </select><br>

          <p>Hai esperienze o interesse nella cucina?</p>
          <select name="cucina" required>
            <option value="">Seleziona</option>
            <option>Lavoro nel settore</option>
            <option>Appassionato/a</option>
            <option>Non particolarmente interessato</option>
          </select><br>

          <p>Con quale dispositivo hai ascoltato i brani?</p>
          <select name="dispositivo" required>
            <option value="">Seleziona</option>
            <option>Cuffie</option>
            <option>Altoparlanti del computer</option>
            <option>Altoparlanti esterni</option>
            <option>Telefono</option>
          </select><br><br>

          <button type="submit" class="btn">Invia le risposte</button>
        </form>
      `;

      // Gestione dell'invio del form finale
      finale.querySelector("#final-form").addEventListener("submit", async (e) => {
        e.preventDefault();
        const datiFinali = Object.fromEntries(new FormData(e.target));
        // Combina tutte le risposte del quiz con i dati finali
        const dataToSend = responses.map(r => ({ ...r, ...datiFinali }));

        try {
          const response = await fetch(endpoint, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(dataToSend)
          });

          if (response.ok) {
            document.body.innerHTML = "<h2>✅ Grazie per aver completato il sondaggio!</h2><p>I tuoi dati sono stati inviati con successo.</p>";
          } else {
            const errorText = await response.text();
            console.error("Errore server durante l'invio:", response.status, errorText);
            document.body.innerHTML = "<h2>⚠️ Errore durante l'invio delle risposte. Riprova più tardi.</h2><p>Si prega di segnalare l'errore se persiste.</p>";
          }
        } catch (error) {
          console.error("Errore di rete durante l'invio:", error);
          document.body.innerHTML = "<h2>⚠️ Errore di connessione. Riprova più tardi.</h2><p>Verifica la tua connessione internet.</p>";
        }
      });

      container.appendChild(finale);
    }

    // Event listener per il pulsante "Accetto e Inizia"
    document.getElementById("start-quiz-btn").addEventListener("click", loadQuestions);

    // Inizialmente, mostra solo il blocco del consenso
    // Il quiz-container sarà nascosto e mostrato solo dopo il consenso
    document.addEventListener("DOMContentLoaded", () => {
      document.getElementById("quiz-container").classList.remove("visible"); // Assicurati che sia nascosto all'inizio
      document.getElementById("consent-block").classList.add("visible"); // Assicurati che il consenso sia visibile
    });

  </script>
</body>
</html>
